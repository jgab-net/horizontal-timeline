angular.module("timeline",[]).directive("timeline",["$interval","$timeout",function(t,e){return{templateUrl:"views/timeline.html",replace:!0,scope:{alias:"@?",items:"=",select:"&?",format:"@?"},controller:["$scope",function(t){this.timelineSettings={width:0,space:42,padding:5},this.steps=[],this.yearSteps=[],t.nodes=[];var e=t.items[0];t.items.forEach(function(i,n){for(var s=moment(i.date).year()-moment(e.date).year(),l=s;l>0;l--)t.nodes.push({type:"info",info:moment(i.date).year()-l});t.nodes.push(angular.extend({type:"node",index:n},i)),e=i}),this.stepUp=function(){var e=this.findStep();e>=0&&e<this.steps.length-1&&(t.style.left=this.steps[++e],t.$apply())},this.stepDown=function(){var e=this.findStep();e>0&&e<this.steps.length&&(t.style.left=this.steps[--e],t.$apply())},this.yearStepUp=function(){var e=this.findYearStep();e>=0&&e<this.yearSteps.length-1&&(t.style.left=this.yearSteps[++e],t.$apply())},this.yearStepDown=function(){var e=this.findYearStep();void 0===e&&(e=this.yearSteps.length-1),e>0&&e<this.yearSteps.length&&(t.style.left=this.yearSteps[--e],t.$apply())},this.findStep=function(){for(var e=0;e<this.steps.length;e++)if(this.steps[e]<=parseInt(t.style.left))return e},this.findYearStep=function(){for(var e=0;e<this.yearSteps.length;e++)if(this.yearSteps[e]<=parseInt(t.style.left))return e},this.move=function(e,i){var e=parseInt(t.style.left)+e;t.style.left=e<=this.timelineSettings.space?e>this.steps[this.steps.length-1]?e:this.steps[this.steps.length-1]:this.timelineSettings.space,t.$apply()},this.getRealItem=function(e){t.select({item:t.items[e.index]})}}],link:function(t,i,n,s){t.alias&&(t.$parent[t.alias]=s.exports),$leftControl=i.find(".btn-left"),$rightControl=i.find(".btn-right"),$leftYearControl=i.find(".btn-left-year"),$rightYearControl=i.find(".btn-right-year"),$timeline=i.find(".timeline"),t.style={left:s.timelineSettings.space},e(function(){$items=i.find(".timeline-item");var e=!1;$items.each(function(i,n){s.steps.push(-1*s.timelineSettings.width+s.timelineSettings.space),"node"===t.nodes[i].type?($(n).css({left:s.timelineSettings.width,bottom:e?s.timelineSettings.padding:"",top:e?"":s.timelineSettings.padding}).addClass(e?"top-line":"bottom-line").addClass("timeline-item-node").data("x",-1*s.timelineSettings.width+s.timelineSettings.space).data("index",i).on("click",function(){$(".item-active").removeClass("item-active"),$(this).addClass("item-active"),s.getRealItem(t.nodes[$(this).data("index")]),t.$apply()}),s.timelineSettings.width+=parseInt($(n).outerWidth(!0)),e=!e):(s.yearSteps.push(-1*s.timelineSettings.width+s.timelineSettings.space),$(n).css({left:s.timelineSettings.width}).addClass("timeline-item-info").data("x",-1*s.timelineSettings.width+s.timelineSettings.space),s.timelineSettings.width+=parseInt($(n).outerWidth(!0)))}),t.style.width=s.timelineSettings.width+i.width(),t.style.left=s.steps[s.steps.length>=3?s.steps.length-3:s.steps.length-1]});$leftControl.on("click",function(){s.stepUp()}),$rightControl.on("click",function(){s.stepDown()}),$leftYearControl.on("click",function(){s.yearStepUp()}),$rightYearControl.on("click",function(){s.yearStepDown()}),interact(".timeline",{context:i}).draggable({inertia:!0,axis:"x",onstart:function(t){$timeline.removeClass("timeline-animation"),i.addClass("timeline-drag")},onmove:function(t){s.move(t.dx,i.width())},onend:function(t){$timeline.addClass("timeline-animation"),i.removeClass("timeline-drag")}}).styleCursor(!0)}}}]).filter("moment",function(){return function(t,e){return moment(t).utc().format(e)}}),angular.module("timeline").run(["$templateCache",function(t){t.put("views/timeline.html",'<div class="timeline-container">\n	<div class="btn-group-vertical timeline-control timeline-control-left" role="group">\n		<div class="btn btn-primary btn-left"><i class="glyphicon glyphicon-triangle-left"></i></div>\n		<div class="btn btn-primary btn-left-year"><i class="glyphicon glyphicon-backward"></i></div>\n	</div>\n	<div class="timeline timeline-animation" ng-style="style">\n		<div class=\'timeline-item\' ng-repeat="node in nodes" ng-class="{\'item-active\':$last}">\n			<div ng-if="node.type === \'node\'">\n				{{ node.date | moment:format? format: \'YYYY-MM-DD\' }}\n			</div>\n			<div ng-if="node.type === \'info\'">\n				{{ node.info }}\n			</div>\n		</div>\n	</div>\n	<div class="timeline-control timeline-control-right btn-group-vertical" role="group">\n		<div class="btn btn-primary btn-right"><i class="glyphicon glyphicon-triangle-right"></i></div>\n		<div class="btn btn-primary btn-right-year"><i class="glyphicon glyphicon-forward"></i></div>\n	</div>\n</div>')}]);